name: Clean up redundant GitHub deployments
description: >-
  Deletes redundant GitHub deployment objects created automatically when workflows reference an
  environment, e.g. to access environment-specific variables or secrets (see
  https://github.com/actions/runner/issues/2120).  These deployments are unnecessary and may cause
  confusion. This action deletes such 'zombie' deployments.

inputs:
  version:
    description: The version of the service and its build artifacts to be deployed
    required: true
  deployment-environment:
    description: The name of the GitHub environment to which the service is being deployed
    required: true
  deployment-payload-marker:
    description: Marker used to identify deployments to be excluded from the cleanup
    required: true

runs:
  using: composite
  steps:
    - name: Verify prerequisite deployment
      shell: bash
      env:
        GH_TOKEN: ${{ github.token }}
        VERSION: ${{ inputs.version }}
        DEPLOYMENT_ENVIRONMENT: ${{ inputs.deployment-environment }}
        DEPLOYMENT_PAYLOAD_MARKER: ${{ inputs.deployment-payload-marker }}
      run: ./.github/actions/delete-redundant-deployments/action.sh
